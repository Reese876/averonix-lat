<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Averonix - Checkout</title>
    <link rel="icon" type="image/png" href="/averonix-favicon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/averonix-favicon.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/averonix-favicon.png">
    <link rel="apple-touch-icon" href="/averonix-favicon.png">
    <link rel="shortcut icon" href="/averonix-favicon.png">
    <style>
        body {
            margin: 0;
            padding: 0;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .error {
            color: #e74c3c;
            margin: 20px;
            padding: 15px;
            border: 1px solid #f8d7da;
            border-radius: 4px;
            background-color: #fff5f5;
            text-align: center;
            max-width: 400px;
        }
    </style>
    <!-- Paddle.js -->
    <script src="https://cdn.paddle.com/paddle/v2/paddle.js"></script>
</head>
<body>
    <div id="error-container" style="display: none;"></div>

    <script>
        // Function to get user data from extension storage
        async function getUserFromExtension() {
            try {
                if (chrome && chrome.storage && chrome.storage.local) {
                    return new Promise((resolve) => {
                        chrome.storage.local.get(['user'], function(result) {
                            console.log('Extension user data:', result.user);
                            resolve(result.user || null);
                        });
                    });
                }
            } catch (error) {
                console.error('Not in extension context or storage not available:', error);
            }
            return null;
        }

        // Function to get user email from URL or extension
        async function getUserEmail() {
            // First try URL parameters
            const urlParams = new URLSearchParams(window.location.search);
            let email = urlParams.get('email');
            
            // If no email in URL, try extension storage
            if (!email) {
                const userData = await getUserFromExtension();
                if (userData && userData.email) {
                    email = userData.email;
                }
            }
            
            // If still no email, try localStorage
            if (!email) {
                email = localStorage.getItem('user_email');
            }
            
            return email;
        }

        const urlParams = new URLSearchParams(window.location.search);
        const planParam = urlParams.get('plan');
        
        let priceId;
        if (planParam === 'annual') {
            priceId = 'pri_01jsharvaa25nvj9mcnj1gebjg';
        } else {
            priceId = 'pri_01jshakmkfh7fwzbqzf7hqgrnt';
        }
        
        
        function showError(message) {
            const errorContainer = document.getElementById('error-container');
            errorContainer.style.display = 'block';
            errorContainer.innerHTML = `
                <div class="error">
                    <p><strong>Error:</strong> ${message}</p>
                    <p><a href="javascript:history.back()" style="color: #3498db;">Go Back</a></p>
                </div>
            `;
        }
        
        (async function() {
            try {
                // Get user email before initializing checkout
                const userEmail = await getUserEmail();
                console.log('User email:', userEmail);

                Paddle.Environment.set('production');
                
                Paddle.Setup({
                    token: 'live_2cbdd04a109d7add9d307a11a1d',
                    eventCallback: function(event) {
                        if (event && event.name) {
                            if (event.name === 'checkout.error') {
                                console.error('Checkout error:', event.data);
                                showError('There was an error processing your checkout.');
                            }
                            if (event.name === 'checkout.closed') {
                                window.location.href = document.referrer || '/plans.html';
                            }
                            if (event.name === 'checkout.complete') {
                                window.location.href = window.location.origin + '?success=true';
                            }
                        }
                    }
                });
                
                const checkoutConfig = {
                    items: [{
                        priceId: priceId,
                        quantity: 1
                    }]
                };

                // Add customer email if available
                if (userEmail) {
                    checkoutConfig.customer = {
                        email: userEmail
                    };
                    console.log('Adding customer email to checkout:', userEmail);
                }
                
                Paddle.Checkout.open(checkoutConfig);
                
            } catch (error) {
                console.error('Paddle initialization error:', error);
                showError('Could not initialize checkout. ' + error.message);
            }
        })();
    </script>
    
</body>
</html> 