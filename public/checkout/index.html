<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Averonix - Checkout</title>
    <link rel="icon" type="image/png" href="/averonix-favicon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/averonix-favicon.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/averonix-favicon.png">
    <link rel="apple-touch-icon" href="/averonix-favicon.png">
    <link rel="shortcut icon" href="/averonix-favicon.png">
    
    <!-- Tarteaucitron.js CSS -->
    <link rel="stylesheet" href="/tarteaucitron/tarteaucitron.css">
    
    <script src="/tarteaucitron/tarteaucitron.min.js"></script>

        <script type="text/javascript">
        tarteaucitron.init({
    	  "privacyUrl": "", /* Privacy policy url */
          "bodyPosition": "top", /* top to bring it as first element for accessibility */

    	  "hashtag": "#tarteaucitron", /* Open the panel with this hashtag */
    	  "cookieName": "tarteaucitron", /* Cookie name */
    
    	  "orientation": "middle", /* Banner position (top - bottom) */
       
          "groupServices": true, /* Group services by category */
          "showDetailsOnClick": true, /* Click to expand the description */
          "serviceDefaultState": "wait", /* Default state (true - wait - false) */
                           
    	  "showAlertSmall": false, /* Show the small banner on bottom right */
    	  "cookieslist": false, /* Show the cookie list in a mini banner */
          "cookieslistEmbed": false, /* Show the cookie list on the control panel */
                           
          "closePopup": true, /* Show a close X on the banner */

          "showIcon": true, /* Show cookie icon to manage cookies */
          //"iconSrc": "", /* Optionnal: URL or base64 encoded image */
          "iconPosition": "BottomRight", /* Position of the cookie (BottomRight - BottomLeft - TopRight - TopLeft) */

    	  "adblocker": false, /* Show a Warning if an adblocker is detected */
                           
          "DenyAllCta" : true, /* Show the deny all button */
          "AcceptAllCta" : true, /* Show the accept all button */
          "highPrivacy": true, /* HIGHLY RECOMMANDED Disable auto consent */
          "alwaysNeedConsent": false, /* Ask the consent for "Privacy by design" services */
                           
    	  "handleBrowserDNTRequest": false, /* If Do Not Track == 1, disallow all */

    	  "removeCredit": false, /* Remove credit link */
    	  "moreInfoLink": true, /* Show more info link */

          "useExternalCss": false, /* Expert mode: do not load the tarteaucitron.css file */
          "useExternalJs": false, /* Expert mode: do not load the tarteaucitron js files */

    	  //"cookieDomain": ".my-multisite-domaine.fr", /* Shared cookie for multisite */
                          
          "readmoreLink": "", /* Change the default readmore link */

          "mandatory": true, /* Show a message about mandatory cookies */
          "mandatoryCta": false, /* Show the disabled accept button when mandatory on */
    
          //"customCloserId": "", /* Optional a11y: Custom element ID used to open the panel */
          
          "googleConsentMode": true, /* Enable Google Consent Mode v2 for Google ads & GA4 */
          "bingConsentMode": true, /* Enable Bing Consent Mode for Clarity & Bing Ads */
          "softConsentMode": false, /* Soft consent mode (consent is required to load the services) */

          "dataLayer": false, /* Send an event to dataLayer with the services status */
          "serverSide": false, /* Server side only, tags are not loaded client side */

           "partnersList": true /* Show the number of partners on the popup/middle banner */
         });
         
         // Add Google Fonts service to trigger banner
         (tarteaucitron.job = tarteaucitron.job || []).push('googlefonts');
         </script>






    <style>
        body {
            margin: 0;
            padding: 0;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .error {
            color: #e74c3c;
            margin: 20px;
            padding: 15px;
            border: 1px solid #f8d7da;
            border-radius: 4px;
            background-color: #fff5f5;
            text-align: center;
            max-width: 400px;
        }
    </style>
    <!-- Paddle.js -->
    <script src="https://cdn.paddle.com/paddle/v2/paddle.js"></script>
</head>
<body>
    <div id="error-container" style="display: none;"></div>

    <script>
        // Function to get user data from extension storage
        async function getUserFromExtension() {
            try {
                if (chrome && chrome.storage && chrome.storage.local) {
                    return new Promise((resolve) => {
                        chrome.storage.local.get(['user'], function(result) {
                            console.log('Extension user data:', result.user);
                            resolve(result.user || null);
                        });
                    });
                }
            } catch (error) {
                console.error('Not in extension context or storage not available:', error);
            }
            return null;
        }

        // Function to get user email from URL or extension
        async function getUserEmail() {
            // First try URL parameters
            const urlParams = new URLSearchParams(window.location.search);
            let email = urlParams.get('email');
            
            // If no email in URL, try extension storage
            if (!email) {
                const userData = await getUserFromExtension();
                if (userData && userData.email) {
                    email = userData.email;
                }
            }
            
            // If still no email, try localStorage
            if (!email) {
                email = localStorage.getItem('user_email');
            }
            
            return email;
        }

        const urlParams = new URLSearchParams(window.location.search);
        const planParam = urlParams.get('plan');
        
        let priceId;
        if (planParam === 'annual') {
            priceId = 'pri_01jsharvaa25nvj9mcnj1gebjg';
        } else {
            priceId = 'pri_01jshakmkfh7fwzbqzf7hqgrnt';
        }
        
        
        function showError(message) {
            const errorContainer = document.getElementById('error-container');
            errorContainer.style.display = 'block';
            errorContainer.innerHTML = `
                <div class="error">
                    <p><strong>Error:</strong> ${message}</p>
                    <p><a href="javascript:history.back()" style="color: #3498db;">Go Back</a></p>
                </div>
            `;
        }
        
        (async function() {
            try {
                // Get user email before initializing checkout
                const userEmail = await getUserEmail();
                console.log('User email:', userEmail);

                Paddle.Environment.set('production');
                
                Paddle.Setup({
                    token: 'live_2cbdd04a109d7add9d307a11a1d',
                    eventCallback: function(event) {
                        if (event && event.name) {
                            if (event.name === 'checkout.error') {
                                console.error('Checkout error:', event.data);
                                showError('There was an error processing your checkout.');
                            }
                            if (event.name === 'checkout.closed') {
                                window.location.href = document.referrer || '/plans.html';
                            }
                            if (event.name === 'checkout.complete') {
                                window.location.href = window.location.origin + '?success=true';
                            }
                        }
                    }
                });
                
                const checkoutConfig = {
                    items: [{
                        priceId: priceId,
                        quantity: 1
                    }]
                };

                // Add customer email if available
                if (userEmail) {
                    checkoutConfig.customer = {
                        email: userEmail
                    };
                    console.log('Adding customer email to checkout:', userEmail);
                }
                
                Paddle.Checkout.open(checkoutConfig);
                
            } catch (error) {
                console.error('Paddle initialization error:', error);
                showError('Could not initialize checkout. ' + error.message);
            }
        })();
    </script>
    
</body>
</html> 